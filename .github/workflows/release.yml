name: Build
on: push
jobs:
  build:
    runs-on: windows-latest
    steps:
        - name: Check out repository code
          uses: actions/checkout@v3
          with:
            fetch-depth: 0
            path: staging
        
        - name: Download frc and build infocards
          run: |
            Invoke-WebRequest "http://adoxa.altervista.org/freelancer/dlt.php?f=frc" -OutFile ${{ github.workspace }}\frc.zip
            Expand-Archive ${{ github.workspace }}\frc.zip
            Start-Process -Wait ${{ github.workspace }}\frc\frc.exe -ArgumentList "staging\mod-assets\infocard_imports.frc", "staging\mod-assets\EXE\BmodInfocards.dll"

        - name: Download the Freelancer XML Project and Compile XML files to UTF
          uses: Amadevus/pwsh-script@v2
          id: script
          with:
            script: |
              Invoke-WebRequest "http://adoxa.altervista.org/freelancer/dlt.php?f=xmlproject" -OutFile ${{ github.workspace }}\xmlproject.zip
              Expand-Archive ${{ github.workspace }}\xmlproject.zip
              $destination = "${{ github.workspace }}\staging\mod-assets\DATA\"
              $files = Get-ChildItem "staging\mod-assets\XML"

              $func = {
              param(     
                  [Parameter(Mandatory)]   
                  [string]$proc,
                  [Parameter(Mandatory)]
                  [string]$params
              )
              Start-Process -FilePath "$proc" -Wait -ArgumentList $params
              }

              foreach($file in $files){
                Start-Job -ScriptBlock $func -Arg @("${github.workspace}\staging\xmlproject\XMLUTF.exe", "-o $destination $($file.FullName)")
                Write-Host "Converting $($file) and writing it to $destination $($file.FullName)"        
              }
              
              


        - name: Add mod zip
          run: |
            type NUL > ${{ github.workspace }}\Assets\Mod\freelancerhd.7z
          shell: cmd
            
        - name: Compile script
          run: |
            "%programfiles(x86)%\Inno Setup 6\iscc.exe" "se